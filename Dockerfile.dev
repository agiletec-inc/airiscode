FROM node:25-bookworm

ARG PNPM_VERSION=10.21.0

ENV PNPM_HOME=/usr/local/pnpm
ENV PNPM_STORE_DIR=/home/app/.local/share/pnpm/store/v3
ENV PATH="${PNPM_HOME}:${PATH}"

RUN apt-get update && \
    apt-get install -y --no-install-recommends \
      build-essential \
      ca-certificates \
      git \
      curl \
      openssh-client \
      python3 \
      pkg-config \
      tini && \
    rm -rf /var/lib/apt/lists/*

# Create dedicated app user
RUN set -eux; \
    if ! id -u app >/dev/null 2>&1; then \
      useradd -m -s /bin/bash app; \
    fi; \
    chown -R app:app /home/app

# Install pnpm via npm
RUN npm install -g pnpm@${PNPM_VERSION}

# Setup pnpm directories
RUN mkdir -p "${PNPM_HOME}" "${PNPM_STORE_DIR}" && \
    chown -R app:app "${PNPM_HOME}" /home/app/.local

WORKDIR /app
USER app

ENTRYPOINT ["tini","--"]
CMD ["sleep","infinity"]
